name: Build Wheel Check

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:  # 添加手动触发器

jobs:
  build:
    name: Build Whl And Install
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Dependencies
      run: |
        pip3 install -r requirements.txt
        pip3 install setuptools

    - name: Install build tools
      run: |
        python -m pip install -U pip wheel setuptools build

    - name: Detect platform & python tag
      id: info
      shell: bash
      run: |
        OS=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)
        case "$OS" in
          linux)  PLAT="linux_$ARCH" ;;
          macos)
            [[ "$ARCH" == "arm64" ]] && PLAT="macosx_11_0_arm64" || PLAT="macosx_10_9_x86_64"
            ;;
          windows) PLAT="win_amd64" ;;
          *) echo "unsupported OS"; exit 1 ;;
        esac
        PYTAG="cp$(python -c 'import sys;print(f"{sys.version_info.major}{sys.version_info.minor}")')"

        echo "plat=$PLAT" >> $GITHUB_OUTPUT
        echo "pytag=$PYTAG" >> $GITHUB_OUTPUT
        echo "==> detected --plat-name=$PLAT --python-tag=$PYTAG"

    - name: Build Library
      run: |
        export AUTO_CI=cpu
        bash build.sh 2>&1 | tee build_output.log
        
    - name: Build wheel
      run: |
        cat > setup.py <<EOF
        from setuptools import setup
        setup()
        EOF
        python setup.py bdist_wheel \
          --plat-name ${{ steps.info.outputs.plat }} \
          --python-tag ${{ steps.info.outputs.pytag }}
