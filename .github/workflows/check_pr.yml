name: Check PR Format

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [dev]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 用 github-script 直接读 PR body，免 checkout 也能跑
      - name: Validate PR description
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const lines = body.split(/\r?\n/);

            // 1. 必须出现的三段标题
            const required = [
              '### PR For',
              '### PR Types',
              '### Description'
            ];
            for (const hdr of required) {
              if (!lines.some(l => l.trim() === hdr)) {
                core.setFailed(`Missing "${hdr}" section in PR description.`);
                return;
              }
            }

            // 2. 取出每段后面的值
            function pickValue(startHdr) {
              const idx = lines.findIndex(l => l.trim() === startHdr);
              if (idx === -1) return null;
              // 下一行非空即为填写内容
              for (let i = idx + 1; i < lines.length; i++) {
                const v = lines[i].trim();
                if (v === '') continue;
                return v.replace(/^-?\s*/, '');   // 去掉列表符号
              }
              return '';
            }

            const forValue    = pickValue('### PR For');
            const typeValue   = pickValue('### PR Types');
            const descValue   = pickValue('### Description');

            // 3. 合法取值表
            const FOR_LIST  = ['Readme', 'Cpp', 'Python', 'Build', 'Others'];
            const TYPE_LIST = ['Feat', 'Fix', 'Performance', 'Code Enhancements',
                               'Deprecations', 'Devs', 'Security', 'Others'];

            if (!FOR_LIST.includes(forValue)) {
              core.setFailed(
                `"### PR For" must be one of [ ${FOR_LIST.join(' | ')} ], now "${forValue}".`
              );
              return;
            }
            if (!TYPE_LIST.includes(typeValue)) {
              core.setFailed(
                `"### PR Types" must be one of [ ${TYPE_LIST.join(' | ')} ], now "${typeValue}".`
              );
              return;
            }
            if (!descValue) {
              core.setFailed('"### Description" cannot be empty.');
              return;
            }

            core.info('PR format check passed ✔');
