name: Build CPU wheels (3.10-3.12 × Linux/macOS/Windows)

on:
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: |
      ${{ matrix.os }} 
      py${{ matrix.py }} 
      ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - { runner: ubuntu-latest, os: linux, py: '3.10', arch: x86_64 }
          - { runner: ubuntu-latest, os: linux, py: '3.11', arch: x86_64 }
          - { runner: ubuntu-latest, os: linux, py: '3.12', arch: x86_64 }

          # macOS universal2（Intel + Apple Silicon）
          - { runner: macos-latest,   os: macos, py: '3.10', arch: universal2 }
          - { runner: macos-latest,   os: macos, py: '3.11', arch: universal2 }
          - { runner: macos-latest,   os: macos, py: '3.12', arch: universal2 }

          # Windows x86_64
          - { runner: windows-latest, os: windows, py: '3.10', arch: AMD64 }
          - { runner: windows-latest, os: windows, py: '3.11', arch: AMD64 }
          - { runner: windows-latest, os: windows, py: '3.12', arch: AMD64 }

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}

      - name: Install build deps
        run: |
          python -m pip install -U pip setuptools wheel

      - name: build_env.sh
        run: bash build_env.sh
        shell: bash

      - name: build.sh
        run: bash build.sh
        shell: bash

      - name: Build wheel
        run: python setup.py bdist_wheel
        shell: bash

      - name: Rename wheel for clarity
        run: |
          cd dist
          for f in *.whl; do
            new=${f//-cp*-/-cp${{ matrix.py }}-${{ matrix.os }}_${{ matrix.arch }}-}
            mv "$f" "$new"
          done
        shell: bash

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
