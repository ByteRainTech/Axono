name: DocString â†’ Docsify â†’ GitHub Pages

on:
  push:
    branches: [ dev ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: {python-version: '3.12'}
      - run: pip install astunparse

      # 1) ç”Ÿæˆ Markdownï¼ˆè·¯å¾„æ”¹æˆ python/axonoï¼‰
      - name: Generate MD
        shell: python
        run: |
          import ast, pathlib, shutil, textwrap

          src_root = pathlib.Path('python/axono')   # ğŸ”§ æ”¹è¿™é‡Œ
          docs_root = pathlib.Path('docs')
          api_dir   = docs_root / 'axono'
          if api_dir.exists(): shutil.rmtree(api_dir)

          for py in src_root.rglob('*.py'):
              rel = py.relative_to(src_root).with_suffix('.md')
              md_file = api_dir / rel
              md_file.parent.mkdir(parents=True, exist_ok=True)

              with open(py, encoding='utf8') as f:
                  tree = ast.parse(f.read(), filename=str(py))

              parts = ['# `{}`'.format(py.stem), '']
              for node in ast.walk(tree):
                  if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef, ast.ClassDef)):
                      doc = ast.get_docstring(node)
                      if not doc: continue
                      parts.append('## `{}`'.format(node.name))
                      parts.append('')
                      parts.append(textwrap.indent(doc, '    '))
                      parts.append('')
              md_file.write_text('\n'.join(parts)+'\n', encoding='utf8')

      # 2) æ›´æ–°ä¾§è¾¹æ 
      - name: Build sidebar
        shell: python
        run: |
          import pathlib
          api = pathlib.Path('docs/axono')
          lines = ['- [Home](/)']
          for md in sorted(api.rglob('*.md')):
              rel   = md.relative_to(api)
              depth = len(rel.parts) - 1
              title = rel.stem.replace('_', ' ').title()
              link  = '/axono/' + str(rel.with_suffix(''))
              lines.append('  '*depth + f'- [{title}]({link})')
          pathlib.Path('docs/_sidebar.md').write_text('\n'.join(lines)+'\n')

      # 3) æäº¤ & éƒ¨ç½²
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(ci): update docsify from DocString'
          file_pattern: 'docs/axono/* docs/_sidebar.md'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with: {path: docs}
      - uses: actions/deploy-pages@v4
