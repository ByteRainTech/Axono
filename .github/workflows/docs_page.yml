name: DocString â†’ Docsify â†’ GitHub Pages

on:
  push:
    branches: [dev]

permissions:
  contents: write   # å†™å› docs
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: {python-version: '3.12'}
      - run: pip install astunparse

      - name: Generate MD
        shell: python
        run: |
          import ast, pathlib, shutil, textwrap

          src_root = pathlib.Path('python/axono')   # ğŸ”§ ä½ çš„æºç æ ¹
          docs_root = pathlib.Path('docs')
          api_dir = docs_root / 'axono'
          if api_dir.exists():
              shutil.rmtree(api_dir)

          for py in src_root.rglob('*.py'):
              rel = py.relative_to(src_root).with_suffix('.md')
              md_file = api_dir / rel
              md_file.parent.mkdir(parents=True, exist_ok=True)

              code = py.read_text(encoding='utf8')
              tree = ast.parse(code, filename=str(py))

              # åªä¿ç•™å¸¦ docstring çš„å‡½æ•°/ç±»
              nodes = [n for n in ast.walk(tree)
                       if isinstance(n, (ast.FunctionDef, ast.AsyncFunctionDef, ast.ClassDef))
                       and ast.get_docstring(n)]

              # ç©º __init__.py ç›´æ¥è·³è¿‡
              if py.name == '__init__.py' and not nodes:
                  continue

              # æ ‡é¢˜ï¼š__init__ ç”¨åŒ…åï¼Œå…¶ä½™ç”¨æ¨¡å—å
              title = py.parent.name if py.name == '__init__.py' else py.stem
              parts = [f'# `{title}`', '']
              for node in nodes:
                  doc = ast.get_docstring(node)
                  parts.append(f'## `{node.name}`')
                  parts.append('')
                  parts.append(textwrap.indent(doc, '    '))
                  parts.append('')
              md_file.write_text('\n'.join(parts) + '\n', encoding='utf8')

      # 2. çœŸæ­£çš„æ ‘å½¢ä¾§è¾¹æ 
      - name: Build sidebar
        shell: python
        run: |
          import pathlib

          api = pathlib.Path('docs/axono')
          lines = ['- [Home](/)']

          # ç”¨ dict å»ºæ ‘
          tree = {}
          for md in sorted(api.rglob('*.md')):
              parts = md.relative_to(api).with_suffix('').parts
              d = tree
              for p in parts[:-1]:
                  d = d.setdefault(p, {})
              d[parts[-1]] = str(md.relative_to(api).with_suffix(''))

          # é€’å½’è¾“å‡º
          def emit(d, depth=0):
              for k, v in d.items():
                  if isinstance(v, dict):          # ç›®å½•
                      lines.append('  ' * depth + f'- {k.replace("_", " ").title()}')
                      emit(v, depth + 1)
                  else:                            # å¶å­æ–‡ä»¶
                      title = k.replace('_', ' ').title()
                      link = '/axono/' + v
                      lines.append('  ' * depth + f'- [{title}]({link})')

          emit(tree)
          pathlib.Path('docs/_sidebar.md').write_text('\n'.join(lines) + '\n')

      # 3. æäº¤ç”Ÿæˆçš„æ–‡æ¡£
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(ci): update docsify from DocString'
          file_pattern: 'docs/axono/* docs/_sidebar.md'

  # 4. éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with: {path: docs}
      - uses: actions/deploy-pages@v4
